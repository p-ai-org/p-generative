<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>P-generative WebPPL Runner</title>

    <link rel="stylesheet" href="https://probmods.github.io/webppl-editor/webppl-editor.css">
    <link rel="stylesheet" href="https://probmods.github.io/webppl-viz/webppl-viz.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">

    <script src="./lib/webppl-v0.9.15.js"></script>
    <script src="https://probmods.github.io/webppl-editor/jquery.js"></script>
    <script src="https://probmods.org/assets/js/webppl-editor.min.js"></script>
    <script src="https://probmods.org/assets/js/webppl-viz.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <header>
        <h1>P-generative WebPPL Runner</h>
        <p>Please insert code into the box below and click run.</p>
        <b style="color: red">Warning - <u>there is no saving functionality!</u>
        Please copy your code to clipboard frequently and paste it back in the original file to save any changes</b>
    </header>

    <pre></pre>

    <script src="https://probmods.org/assets/js/paper-full.js"></script>
    <script src="https://probmods.org/assets/js/draw.js"></script>
    <script src="https://probmods.org/assets/js/box2d.js"></script>
    <script src="https://probmods.org/assets/js/physics.js"></script>
    <script>
        // from some prodmods js asset (physics.js I think), modified to accommodate drawing rotated rectangles and also drawing worlds run through the physics engine 
        applyWorld = function (initialWorld) {
            var worldList = initialWorld;
            _.each(
                worldList,
                function (obj) {
                    var shape = obj.shape,
                        dims = obj.dims,
                        velocity = obj.velocity || [0, 0];
                    bodyDef.type = obj.static ? b2Body.b2_staticBody : b2Body.b2_dynamicBody;
                    if (shape == "circle") {
                        var r = dims[0] / SCALE;
                        fixDef.shape = new b2CircleShape(r);
                    } else if (shape == "rect") {
                        var w = dims[0] / SCALE;
                        var h = dims[1] / SCALE;
                        fixDef.shape = new b2PolygonShape;
                        fixDef.shape.SetAsOrientedBox(w, h, new b2Vec2(0, 0), 0.0);
                    } else {
                        throw new Error('unknown shape ' + shape);
                    }
                    bodyDef.position.x = obj.x / SCALE;
                    bodyDef.position.y = obj.y / SCALE;
                    bodyDef.linearVelocity.x = velocity[0] / SCALE;
                    bodyDef.linearVelocity.y = velocity[1] / SCALE;
                    world.CreateBody(bodyDef).CreateFixture(fixDef);
                }
            )
            return initialWorld;
        }
        churchWorld_from_bodyList = function (body) {
            var worldList = [];
            while (body) {
                var isStatic = !(body.GetType() == 2);
                var shapeInt = body.GetFixtureList().GetType();
                var shape;
                var dims;
                if (shapeInt == 0) {
                    shape = "circle";
                    dims = [body.GetFixtureList().GetShape().GetRadius() * SCALE];
                } else {
                    shape = "rect";
                    var vertices = body.GetFixtureList().GetShape().GetVertices();
                    dims = [vertices[2].x * SCALE, vertices[2].y * SCALE];
                    angle = body.GetAngle() * 180 / Math.PI;
                }
                var x = body.GetPosition().x * SCALE;
                var y = body.GetPosition().y * SCALE;
                worldList.push({
                    shape: shape,
                    static: isStatic,
                    dims: dims,
                    x: x,
                    y: y,
                    angle: angle
                });
                body = body.GetNext();
            }
            return worldList;
        }
        DrawObject.prototype.rectangle = function (x1, y1, x2, y2, stroke, fill, opacity, angle) {
            var rect = new this.paper.Path.Rectangle(this.newPoint(x1, y1), this.newPoint(x2, y2));
            rect.fillColor = (fill == 'none' ? new paper.Color(1, 1, 1, 0) : (fill || 'white'));
            rect.strokeColor = stroke || 'black';
            rect.opacity = opacity || 1;
            rect.rotate(angle || 0.0, (x1 + x2) / 2, (y1 + y2) / 2);
            this.redraw();
        };

        // from dippl.org/examples/vision.html, used by the DrawObject.prototype.distance function
        function euclideanDistance(v1, v2){
            var i;
            var d = 0;
            for (i = 0; i < v1.length; i++) {
                d += (v1[i] - v2[i])*(v1[i] - v2[i]);
            }
            return Math.sqrt(d);
        };
    </script>

    <script>
        // find all <pre> elements and set up the editor on them
        var preEls = Array.prototype.slice.call(document.querySelectorAll("pre"));
        preEls.map(function (el) { editor.setup(el, { language: 'webppl' }); });
    </script>

    </div>

</body>

</html>